<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <title>智能农业监测系统 - 报告管理</title>
    <style>
        /* ===== 统一设计变量 ===== */
        :root {
            /* 主色 */
            --primary: #22c55e;
            /* 农业绿 */
            --primary-light: #dcfce7;
            /* 浅绿背景 */
            --secondary: #f97316;
            /* 警示橙 */
            --danger: #ef4444;
            /* 预警红 */
            --dark: #1f2937;
            /* 深灰文字 */
            --light: #f3f4f6;
            /* 页面背景 */

            /* 功能色 */
            --border: #e5e7eb;
            /* 边框 */
            --radius: 0.75rem;
            /* 圆角统一 12px */
            --shadow: 0 4px 20px rgba(0, 0, 0, .08);
            /* 卡片阴影 */
            --font-sans: "Inter", "Microsoft YaHei", Arial, system-ui, sans-serif;
        }

        /* ===== 全局重置 ===== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: var(--font-sans);
        }

        body {
            background: var(--light);
            color: var(--dark);
            -webkit-font-smoothing: antialiased;
        }

        /* ===== 顶部导航 ===== */
        header {
            height: 60px;
            background: #fff;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-left,
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-left img {
            height: 40px
        }

        .header-right img {
            height: 30px;
            border-radius: 50%;
        }

        .modal-content.zero-padding {
            padding: 0;
        }

        /* ===== 侧边栏 ===== */
        aside {
            width: 250px;
            background: #fff;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px 0;
            flex-shrink: 0;
        }

        nav ul {
            list-style: none
        }

        nav ul li {
            margin-bottom: 5px
        }

        nav ul li a {
            display: block;
            padding: 12px 20px;
            color: #6b7280;
            border-left: 4px solid transparent;
            transition: all .25s;
            border-radius: 0 6px 6px 0;
        }

        nav ul li a:hover,
        nav ul li.active a {
            background: var(--primary-light);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        /* 农场信息卡片 */
        .farm-info {
            padding: 20px;
            background: var(--primary-light);
            margin: 20px 16px 0;
            border-radius: var(--radius);
        }

        .farm-info h3 {
            margin-bottom: 15px;
            color: var(--primary);
            font-size: 16px;
            font-weight: 600;
        }

        .farm-info p {
            margin-bottom: 8px;
            font-size: 14px;
            color: #4b5563;
        }

        /* ===== 主内容区 ===== */
        main {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .container {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .content-header h2 {
            color: var(--dark);
            font-size: 20px;
            font-weight: 700;
        }

        /* ===== 通用卡片 ===== */
        .query-section,
        .report-list,
        .modal-content {
            background: #fff;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
        }

        /* ===== 表单 ===== */
        .query-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }

        .form-group {
            flex: 1 1 200px;
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 6px;
            font-weight: 600;
            color: #4b5563;
            font-size: 14px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color .2s, box-shadow .2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-light);
        }

        /* ===== 按钮 ===== */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background .25s, color .25s;
            border: none;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: #1db954
        }

        .btn-secondary {
            background: #e5e7eb;
            color: var(--dark);
        }

        .btn-secondary:hover {
            background: #d1d5db
        }

        .btn-success {
            background: #10b981;
            color: #fff
        }

        .btn-success:hover {
            background: #059669
        }

        .btn-danger {
            background: var(--danger);
            color: #fff
        }

        .btn-danger:hover {
            background: #dc2626
        }

        .btn-outline {
            border: 1px solid var(--border);
            background: #fff;
            color: var(--dark);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* ===== 表格 ===== */
        .report-list table {
            width: 100%;
            border-collapse: collapse;
        }

        .report-list th,
        .report-list td {
            padding: 12px 16px;
            text-align: left;
            font-size: 14px;
        }

        .report-list th {
            background: #f9fafb;
            font-weight: 600;
            color: #6b7280;
        }

        .report-list tr:nth-child(even) {
            background: #f9fafb
        }

        .report-list tr:hover {
            background: var(--primary-light)
        }

        .report-list tr:hover td {
            color: var(--primary)
        }

        /* ===== 模态框：全屏固定 + 水平垂直居中 ===== */
        .modal {
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            /* 初始隐藏 */
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, .45);
        }

        /* 弹窗内容：给最小尺寸，防止空壳 */
        .modal-content {
            position: relative;
            /* 让右上角 × 绝对定位参照它 */
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 28px rgba(0, 0, 0, .15);
            padding: 24px;
            min-width: 420px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* === 3. 动态表单区如果再高，就继续内部滚（双重保险） === */
        #reportDynamicArea {
            max-height: 40vh;
            /* 大约一半视口，可再调 */
            overflow-y: auto;
        }

        .close {
            position: absolute;
            right: 16px;
            top: 16px;
            font-size: 24px;
            color: #9ca3af;
            cursor: pointer;
        }

        .close:hover {
            color: var(--dark)
        }

        /* ===== 进度条 ===== */
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f3f3f3;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            color: #fff;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: width .3s ease;
        }

        /* ===== 加载动画 ===== */
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 4px solid rgba(0, 0, 0, .1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        /* ===== 错误提示 ===== */
        .error-message {
            color: var(--danger);
            text-align: center;
            padding: 20px;
        }

        body.iframe-embedded header {
            display: none !important;
        }

        body.iframe-embedded {
            padding-top: 0 !important;
            margin-top: 0 !important;
        }

        /* 把 tailwind 可能留空的类一次性清零 */
        body.iframe-embedded .pt-16,
        body.iframe-embedded .pt-20,
        body.iframe-embedded .pt-24,
        body.iframe-embedded .pt-32,
        body.iframe-embedded .mt-16,
        body.iframe-embedded .mt-20,
        body.iframe-embedded .mt-24,
        body.iframe-embedded .mt-32 {
            padding-top: 0 !important;
            margin-top: 0 !important;
        }

        /* ===== 顶部导航（与 main.html 同款深灰+毛玻璃） ===== */
        header {
            height: 60px;
            background: rgba(31, 41, 55, .95);
            /* main.html 的深灰 + 透明度 */
            box-shadow: 0 4px 20px rgba(0, 0, 0, .25);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-left,
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .header-left span,
        .header-right span {
            color: #fff;
            font-size: 16px;
            font-weight: 500
        }

        /* 文字强制白色 */
        .header-left img {
            height: 40px
        }

        .header-right img {
            height: 30px;
            border-radius: 50%
        }

        /* ===== 左上角 Logo 区域（与 main.html 同款绿叶 + 文字） ===== */
        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-left::before {
            content: "\f06c";
            /* FontAwesome 绿叶 unicode */
            font-family: "FontAwesome";
            font-size: 24px;
            color: #22c55e;
            /* 农业绿 */
        }

        .header-left span {
            font-size: 20px;
            font-weight: 700;
            color: #fff;
        }

        .header-left::after {
            content: "| 智慧农业控制台";
            margin-left: 8px;
            font-size: 14px;
            color: #d1d5db;
        }

        /* 左侧边栏 */
        /* ===== 左侧边栏（与 planning-mgmt.html 完全一致） ===== */
        aside {
            width: 256px;
            /* tailwind md:w-64 */
            background: #fff;
            border-radius: 12px;
            /* rounded-xl */
            box-shadow: 0 4px 20px rgba(0, 0, 0, .08);
            /* card-shadow */
            padding: 16px;
            /* p-4 */
            flex-shrink: 0;
        }

        aside nav {
            display: flex;
            flex-direction: column;
            gap: 4px;
            /* space-y-1 */
        }

        aside nav a {
            display: flex;
            align-items: center;
            gap: 12px;
            /* space-x-3 */
            padding: 12px 16px;
            /* px-4 py-3 */
            border-radius: 8px;
            /* rounded-lg */
            font-size: 14px;
            color: #6b7280;
            /* text-gray-500 */
            transition: all .3s;
            border-left: 4px solid transparent;
        }

        aside nav a:hover {
            background: #f9fafb;
            /* hover:bg-gray-50 */
            color: #111827;
            /* hover:text-gray-900 */
        }

        aside nav a.active {
            background: rgba(34, 197, 94, .1);
            /* bg-primary/10 */
            color: #22c55e;
            /* text-primary */
            border-left-color: #22c55e;
            /* border-l-4 border-primary */
        }

        aside nav a i {
            font-size: 16px;
            width: 16px;
            /* 固定宽度，图标对齐 */
        }

        aside nav a span:last-child {
            margin-left: auto;
            /* 右侧元素（如数量角标）顶到最右 */
        }

        /* 农场信息卡片（与 planning-mgmt.html 同款） */
        aside .farm-info {
            margin-top: 32px;
            /* mt-8 */
            background: rgba(34, 197, 94, .05);
            /* bg-primary/5 */
            border-radius: 12px;
            /* rounded-xl */
            padding: 16px;
            /* p-4 */
        }

        aside .farm-info h3 {
            font-weight: 500;
            font-size: 16px;
            color: #22c55e;
            /* text-primary */
            margin-bottom: 12px;
            /* mb-3 */
        }

        aside .farm-info .space-y-2>div {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        aside .farm-info .space-y-2 .text-gray-600 {
            color: #4b5563;
        }

        aside .farm-info .space-y-2 .font-medium {
            font-weight: 500;
            color: #111827;
        }

        aside .farm-info .space-y-2 .text-primary {
            color: #22c55e;
        }

        /* ===== 弹窗卡片级样式 ===== */
        .modal-card {
            width: 640px;
            max-width: 90vw;
            max-height: 90vh;
            /* ① 整体限高 */
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.18);
            overflow: hidden;
            /* ② 隐藏溢出 */
            display: flex;
            flex-direction: column;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 28px;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: #fff;
        }

        .card-header h3 {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .card-header .close {
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .card-header .close:hover {
            transform: rotate(90deg);
        }

        .card-body {
            padding: 28px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow-y: auto;
            /* ③ 关键：内部滚动 */
            flex: 1;
            /* 占满剩余空间 */
        }


        .card-section h4 {
            font-size: 15px;
            font-weight: 600;
            color: #16a34a;
            margin-bottom: 12px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-item.full {
            grid-column: 1 / -1;
        }

        .form-item label {
            font-size: 13px;
            color: #4b5563;
        }

        .base-input,
        .base-select {
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .base-input:focus,
        .base-select:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
        }

        .card-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 0 28px 24px;
        }

        .btn-cancel,
        .btn-confirm {
            padding: 9px 20px;
            font-size: 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-cancel {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-cancel:hover {
            background: #e5e7eb;
        }

        .btn-confirm {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: #fff;
        }

        .btn-confirm:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
        }
    </style>
</head>

<body>
    <!-- 头部 -->
    <header>
        <div class="header-left">
            <span>Agri Platform</span>
        </div>
        <div class="header-right">
            <span id="userName">--</span>
        </div>
    </header>

    <!-- 主体布局 -->
    <div class="container">
        <!-- 侧边栏 -->
        <aside>
            <!-- 农场信息 -->
            <div class="farm-info">
                <h3>农场信息</h3>
                <div id="farmInfoContent">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p>加载中...</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- 主内容区域 -->
        <main>
            <div class="content-header">
                <h2>报告管理</h2>
                <button class="btn btn-primary" onclick="openModal('generateReportModal')">生成报告</button>
            </div>

            <!-- 查询区域 -->
            <div class="query-section">
                <div class="query-form">
                    <div class="form-group">
                        <label for="reportTypeQuery">报告类型</label>
                        <select id="reportTypeQuery">
                            <option value="">全部</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportDate">开始日期</label>
                        <input type="date" id="reportDate">
                    </div>
                    <div class="form-group">
                        <label>结束日期</label>
                        <input type="date" id="endDate">
                    </div>
                    <div class="form-group">
                        <label for="reportStatus">状态</label>
                        <select id="reportStatus">
                            <option value="">全部</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportKeyword">关键词</label>
                        <input type="text" id="reportKeyword" placeholder="请输入关键词">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="queryReports()">查询</button>
                        <button class="btn btn-secondary" onclick="resetQuery()">重置</button>
                    </div>
                </div>
            </div>

            <!-- 报告列表 -->
            <div class="report-list">
                <div id="reportListContent">
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p>加载报告列表中...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 生成报告模态框 -->
    <!-- 1. 生成报告按钮（主页面里的）不用动，只替换弹窗本体 ↓ -->

    <div id="generateReportModal" class="modal">
        <div class="modal-card">
            <!-- 头部 -->
            <div class="card-header">
                <h3>生成报告</h3>
                <span class="close" onclick="closeModal('generateReportModal')">&times;</span>
            </div>

            <!-- 内容区 -->
            <div class="card-body">
                <!-- 1. 基本信息 -->
                <section class="card-section">
                    <h4>① 报告基本信息</h4>
                    <div class="form-grid">
                        <div class="form-item">
                            <label>报告类型</label>
                            <select id="reportType" class="base-select"></select>
                        </div>
                        <div class="form-item">
                            <label>报告标题</label>
                            <input id="reportTitle" type="text" placeholder="请输入报告标题" class="base-input">
                        </div>
                        <div class="form-item">
                            <label>开始日期</label>
                            <input id="reportStartDate" type="date" class="base-input">
                        </div>
                        <div class="form-item">
                            <label>结束日期</label>
                            <input id="reportEndDate" type="date" class="base-input">
                        </div>
                        <div class="form-item full">
                            <label>报告作者</label>
                            <input id="reportAuthor" type="text" placeholder="请输入作者姓名" class="base-input">
                        </div>
                    </div>
                </section>

                <!-- 2. 动态内容 -->
                <section class="card-section">
                    <h4>② 报告内容</h4>
                    <div id="reportDynamicArea"></div>
                </section>

                <!-- 3. 共享设置 -->
                <section class="card-section">
                    <h4>③ 共享设置</h4>
                    <div class="form-grid">
                        <div class="form-item">
                            <label>共享给</label>
                            <select id="shareWith" multiple class="base-select"></select>
                        </div>
                        <div class="form-item">
                            <label>访问权限</label>
                            <select id="accessPermission" class="base-select">
                                <option value="view">仅查看</option>
                                <option value="edit">可编辑</option>
                                <option value="export">可导出</option>
                            </select>
                        </div>
                    </div>
                </section>
            </div>

            <!-- 底部按钮 -->
            <div class="card-footer">
                <button class="btn-cancel" onclick="closeModal('generateReportModal')">取消</button>
                <button class="btn-confirm" onclick="generateReport()">立即生成</button>
            </div>
        </div>
    </div>

    <!-- 查看报告模态框 -->
    <div id="viewReportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('viewReportModal')">&times;</span>
            <div id="viewReportContent">
            </div>
        </div>
    </div>

    <!-- 编辑报告模态框 -->
    <div id="editReportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editReportModal')">&times;</span>
            <h3>编辑报告</h3>
            <!-- 编辑报告表单内容与生成报告类似，这里省略 -->
        </div>
    </div>

    <!-- 分享报告模态框 -->
    <div id="shareReportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('shareReportModal')">&times;</span>
            <div id="shareReportContent">
            </div>
        </div>
    </div>

    <script>
        if (window.self !== window.top) {
            document.documentElement.classList.add('iframe-embedded');
            document.body.classList.add('iframe-embedded');
            document.body.style.paddingTop = '0';
            document.body.style.marginTop = '0';
        }
        // API基础URL
        const API_BASE_URL = '/api';

        // DOM加载完成后执行
        document.addEventListener('DOMContentLoaded', function () {
            // 获取用户信息
            fetchUserInfo();

            // 获取农场信息
            fetchFarmInfo();

            // 获取报告类型
            fetchReportTypes();

            // 获取报告状态
            fetchReportStatuses();

            // 获取共享对象
            fetchShareObjects();

            // 获取报告列表
            fetchReports();

            // 报告类型切换事件
            document.getElementById('reportType').addEventListener('change', function () {
                const selectedType = this.value;
                showReportContent(selectedType);
            });
        });

        // 获取用户信息
        function fetchUserInfo() {
            // 模拟API调用
            setTimeout(() => {
                document.getElementById('userName').textContent = '农场主A';
            }, 1000);
        }

        // 获取农场信息
        function fetchFarmInfo() {
            // 模拟API调用
            setTimeout(() => {
                const farmInfoContent = document.getElementById('farmInfoContent');
                farmInfoContent.innerHTML = `
                    <p>农场名称：绿色生态农场</p>
                    <p>位置：北京市大兴区</p>
                    <p>面积：1000亩</p>
                    <p>作物类型：小麦、玉米、蔬菜</p>
                    <p>监测点数量：20个</p>
                `;
            }, 1500);
        }

        // 获取报告类型
        function fetchReportTypes() {
            // 模拟API调用
            setTimeout(() => {
                const reportTypeSelects = [
                    document.getElementById('reportType'),
                    document.getElementById('reportTypeQuery')
                ];

                const reportTypes = [
                    { value: 'basicMonitoring', text: '基础监测数据报告' },
                    { value: 'cropGrowth', text: '作物生长分析报告' },
                    { value: 'resourceEfficiency', text: '资源效率报告' },
                    { value: 'environmentalImpact', text: '环境影响评估报告' },
                    { value: 'comprehensiveValue', text: '综合价值评估报告' },
                    { value: 'custom', text: '自定义报告' }
                ];

                reportTypeSelects.forEach(select => {
                    if (select) {
                        reportTypes.forEach(type => {
                            const option = document.createElement('option');
                            option.value = type.value;
                            option.textContent = type.text;
                            select.appendChild(option);
                        });
                    }
                });
            }, 1000);
        }

        // 获取报告状态
        function fetchReportStatuses() {
            // 模拟API调用
            setTimeout(() => {
                const reportStatusSelect = document.getElementById('reportStatus');
                if (reportStatusSelect) {
                    const reportStatuses = [
                        { value: 'generated', text: '已生成' },
                        { value: 'shared', text: '已共享' },
                        { value: 'archived', text: '已归档' }
                    ];

                    reportStatuses.forEach(status => {
                        const option = document.createElement('option');
                        option.value = status.value;
                        option.textContent = status.text;
                        reportStatusSelect.appendChild(option);
                    });
                }
            }, 1000);
        }

        // 获取共享对象
        function fetchShareObjects() {
            // 模拟API调用
            setTimeout(() => {
                const shareWithSelect = document.getElementById('shareWith');
                if (shareWithSelect) {
                    const shareObjects = [
                        { value: 'user1', text: '农场主B' },
                        { value: 'user2', text: '技术人员' },
                        { value: 'user3', text: '管理员' },
                        { value: 'group1', text: '农场管理组' }
                    ];

                    shareObjects.forEach(obj => {
                        const option = document.createElement('option');
                        option.value = obj.value;
                        option.textContent = obj.text;
                        shareWithSelect.appendChild(option);
                    });
                }
            }, 1000);
        }

        // 获取报告列表
        function fetchReports(params = {}) {
            try {
                // 显示加载状态
                document.getElementById('reportListContent').innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <p>加载报告列表中...</p>
                    </div>
                `;

                // 模拟API调用
                setTimeout(() => {
                    // 模拟报告数据
                    const reports = [
                        {
                            id: 1,
                            name: '2024年第一季度基础监测报告',
                            type: 'basicMonitoring',
                            generateTime: '2024-04-01',
                            author: '农场主A',
                            status: 'generated',
                            content: {
                                temperatureData: '15-25°C',
                                humidityData: '60-80%',
                                soilMoisture: '40-60%',
                                lightIntensity: '1000-5000 lux'
                            }
                        },
                        {
                            id: 2,
                            name: '小麦生长分析报告',
                            type: 'cropGrowth',
                            generateTime: '2024-03-25',
                            author: '技术人员',
                            status: 'shared',
                            content: {
                                growthStage: '拔节期',
                                growthRate: '正常',
                                yieldPrediction: '亩产800斤',
                                diseaseRisk: '低'
                            }
                        },
                        {
                            id: 3,
                            name: '水资源利用效率评估',
                            type: 'resourceEfficiency',
                            generateTime: '2024-03-20',
                            author: '农场主A',
                            status: 'generated',
                            content: {
                                waterUsage: '70%',
                                fertilizerUsage: '65%',
                                energyConsumption: '1200度/亩',
                                resourceEfficiency: '良好'
                            }
                        },
                        {
                            id: 4,
                            name: '农场环境影响评估',
                            type: 'environmentalImpact',
                            generateTime: '2024-03-15',
                            author: '农场主A',
                            status: 'archived',
                            content: {
                                carbonFootprint: '500kg/亩',
                                waterPollution: '低',
                                biodiversity: '中等',
                                sustainabilityScore: '85'
                            }
                        },
                        {
                            id: 5,
                            name: '2024年综合价值评估报告',
                            type: 'comprehensiveValue',
                            generateTime: '2024-03-10',
                            author: '管理员',
                            status: 'shared',
                            content: {
                                economicValue: '高',
                                socialValue: '中等',
                                environmentalValue: '高',
                                comprehensiveScore: '88'
                            }
                        }
                    ];

                    // 根据参数筛选报告
                    let filteredReports = reports;

                    if (params.type) {
                        filteredReports = filteredReports.filter(report => report.type === params.type);
                    }

                    const start = params.startDate;
                    const end = params.endDate;
                    if (start || end) {                       // ← 只要有一个值就过滤
                        filteredReports = filteredReports.filter(r => {
                            const t = new Date(r.generateTime);
                            return (!start || t >= new Date(start)) &&
                                (!end || t <= new Date(end));
                        });
                    }

                    if (params.status) {
                        filteredReports = filteredReports.filter(report => report.status === params.status);
                    }

                    if (params.keyword) {
                        const keyword = params.keyword.toLowerCase();
                        filteredReports = filteredReports.filter(report =>
                            report.name.toLowerCase().includes(keyword) ||
                            report.author.toLowerCase().includes(keyword)
                        );
                    }

                    // 渲染报告列表
                    renderReportList(filteredReports);
                }, 1500);
            } catch (error) {
                console.error('获取报告列表失败:', error);
                document.getElementById('reportListContent').innerHTML = `
                    <div class="error-message">
                        <p>报告列表加载失败，请稍后重试</p>
                        <button class="btn btn-secondary" onclick="fetchReports()">重试</button>
                    </div>
                `;
            }
        }

        // 渲染报告列表
        function renderReportList(reports) {
            try {
                if (!reports || reports.length === 0) {
                    document.getElementById('reportListContent').innerHTML = `
                        <div style="text-align: center; padding: 50px;">
                            <p>暂无报告数据</p>
                            <button class="btn btn-primary" onclick="openModal('generateReportModal')">生成新报告</button>
                        </div>
                    `;
                    return;
                }

                let reportListHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>报告名称</th>
                                <th>报告类型</th>
                                <th>生成时间</th>
                                <th>作者</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                // 状态中文映射
                const statusMap = {
                    'generated': '已生成',
                    'shared': '已共享',
                    'archived': '已归档'
                };

                // 报告类型中文映射
                const typeMap = {
                    'basicMonitoring': '基础监测数据报告',
                    'cropGrowth': '作物生长分析报告',
                    'resourceEfficiency': '资源效率报告',
                    'environmentalImpact': '环境影响评估报告',
                    'comprehensiveValue': '综合价值评估报告',
                    'custom': '自定义报告'
                };

                reports.forEach(report => {
                    reportListHTML += `
                        <tr>
                            <td>${report.name}</td>
                            <td>${typeMap[report.type] || report.type}</td>
                            <td>${report.generateTime}</td>
                            <td>${report.author}</td>
                            <td>${statusMap[report.status] || report.status}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="viewReport(${report.id})">查看</button>
                                <button class="btn btn-primary" onclick="editReport(${report.id})">编辑</button>
                                <button class="btn btn-success" onclick="shareReport(${report.id})">分享</button>
                                <button class="btn btn-primary" onclick="exportReport(${report.id})">导出</button>
                            </td>
                        </tr>
                    `;
                });

                reportListHTML += `
                        </tbody>
                    </table>
                `;

                document.getElementById('reportListContent').innerHTML = reportListHTML;
            } catch (error) {
                console.error('渲染报告列表失败:', error);
                document.getElementById('reportListContent').innerHTML = `
                    <div class="error-message">
                        <p>报告列表渲染失败，请稍后重试</p>
                        <button class="btn btn-secondary" onclick="fetchReports()">重试</button>
                    </div>
                `;
            }
        }

        // 查询报告
        function queryReports() {
            try {
                const params = {
                    type: document.getElementById('reportTypeQuery')?.value ?? '',
                    startDate: document.getElementById('startDate')?.value ?? '',
                    endDate: document.getElementById('endDate')?.value ?? '',
                    status: document.getElementById('reportStatus')?.value ?? '',
                    keyword: document.getElementById('reportKeyword')?.value ?? ''
                };

                fetchReports(params);
            } catch (error) {
                console.error('查询报告失败:', error);
                alert('查询报告失败，请稍后重试');
            }
        }

        // 重置查询条件
        function resetQuery() {
            try {
                document.getElementById('reportTypeQuery').value = '';
                document.getElementById('reportDate').value = '';
                document.getElementById('reportStatus').value = '';
                document.getElementById('reportKeyword').value = '';
                document.getElementById('endDate').value = '';

                // 重新获取所有报告
                fetchReports();
            } catch (error) {
                console.error('重置查询条件失败:', error);
                alert('重置查询条件失败，请稍后重试');
            }
        }

        // 根据报告类型生成动态表单
        function showReportContent(type) {
            const area = document.getElementById('reportDynamicArea');
            if (!type) { area.innerHTML = ''; return; }

            const templates = {
                basicMonitoring: `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">温度数据</label><input id="temperatureData" type="text" placeholder="例：15-25°C" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">湿度数据</label><input id="humidityData" type="text" placeholder="例：60-80%" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">土壤湿度</label><input id="soilMoisture" type="text" placeholder="例：40-60%" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">光照强度</label><input id="lightIntensity" type="text" placeholder="例：1000-5000 lux" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
      </div>`,
                cropGrowth: `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">生长阶段</label><input id="growthStage" type="text" placeholder="例：拔节期" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">生长速率</label><input id="growthRate" type="text" placeholder="例：正常" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">产量预测</label><input id="yieldPrediction" type="text" placeholder="例：亩产800斤" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">病害风险</label><input id="diseaseRisk" type="text" placeholder="例：低" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
      </div>`,
                resourceEfficiency: `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">水资源利用率</label><input id="waterUsage" type="text" placeholder="例：70%" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">肥料利用率</label><input id="fertilizerUsage" type="text" placeholder="例：65%" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">能源消耗</label><input id="energyConsumption" type="text" placeholder="例：1200度/亩" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">资源效率</label><input id="resourceEfficiency" type="text" placeholder="例：良好" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
      </div>`,
                environmentalImpact: `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">碳足迹</label><input id="carbonFootprint" type="text" placeholder="例：500kg/亩" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">水污染指数</label><input id="waterPollution" type="text" placeholder="例：低" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">生物多样性</label><input id="biodiversity" type="text" placeholder="例：中等" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">可持续性评分</label><input id="sustainabilityScore" type="text" placeholder="例：85" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
      </div>`,
                comprehensiveValue: `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">经济价值</label><input id="economicValue" type="text" placeholder="例：高" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">社会价值</label><input id="socialValue" type="text" placeholder="例：中等" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">环境价值</label><input id="environmentalValue" type="text" placeholder="例：高" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">综合评分</label><input id="comprehensiveScore" type="text" placeholder="例：88" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
      </div>`,
                custom: `
      <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">自定义报告名称</label><input id="customReportName" type="text" placeholder="请输入名称" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">报告类型</label>
          <select id="customReportType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
            <option value="text">文本报告</option>
            <option value="table">表格报告</option>
            <option value="chart">图表报告</option>
          </select>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">报告内容</label><textarea id="customReportContent" rows="6" placeholder="请输入正文..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"></textarea></div>
      </div>`
            };
            area.innerHTML = templates[type] || '';
        }

        // 生成报告
        function generateReport() {
            try {
                // 获取报告类型
                const reportType = document.getElementById('reportType').value;

                if (!reportType) {
                    alert('请选择报告类型');
                    return;
                }

                // 收集基本信息
                const reportData = {
                    type: reportType,
                    title: document.getElementById('reportTitle').value,
                    startDate: document.getElementById('reportStartDate').value,
                    endDate: document.getElementById('reportEndDate').value,
                    author: document.getElementById('reportAuthor').value,
                    shareWith: Array.from(document.getElementById('shareWith').selectedOptions).map(option => option.value),
                    accessPermission: document.getElementById('accessPermission').value,
                    content: {}
                };

                // 根据报告类型收集内容
                switch (reportType) {
                    case 'basicMonitoring':
                        reportData.content = {
                            temperatureData: document.getElementById('temperatureData').value,
                            humidityData: document.getElementById('humidityData').value,
                            soilMoisture: document.getElementById('soilMoisture').value,
                            lightIntensity: document.getElementById('lightIntensity').value
                        };
                        break;
                    case 'cropGrowth':
                        reportData.content = {
                            growthStage: document.getElementById('growthStage').value,
                            growthRate: document.getElementById('growthRate').value,
                            yieldPrediction: document.getElementById('yieldPrediction').value,
                            diseaseRisk: document.getElementById('diseaseRisk').value
                        };
                        break;
                    case 'resourceEfficiency':
                        reportData.content = {
                            waterUsage: document.getElementById('waterUsage').value,
                            fertilizerUsage: document.getElementById('fertilizerUsage').value,
                            energyConsumption: document.getElementById('energyConsumption').value,
                            resourceEfficiency: document.getElementById('resourceEfficiency').value
                        };
                        break;
                    case 'environmentalImpact':
                        reportData.content = {
                            carbonFootprint: document.getElementById('carbonFootprint').value,
                            waterPollution: document.getElementById('waterPollution').value,
                            biodiversity: document.getElementById('biodiversity').value,
                            sustainabilityScore: document.getElementById('sustainabilityScore').value
                        };
                        break;
                    case 'comprehensiveValue':
                        reportData.content = {
                            economicValue: document.getElementById('economicValue').value,
                            socialValue: document.getElementById('socialValue').value,
                            environmentalValue: document.getElementById('environmentalValue').value,
                            comprehensiveScore: document.getElementById('comprehensiveScore').value
                        };
                        break;
                    case 'custom':
                        reportData.content = {
                            customReportName: document.getElementById('customReportName').value,
                            customReportType: document.getElementById('customReportType').value,
                            customReportContent: document.getElementById('customReportContent').value
                        };
                        break;
                }

                // 模拟API调用，实际项目中替换为真实API
                setTimeout(() => {
                    alert('报告生成成功！');
                    closeModal('generateReportModal');
                    fetchReports();
                }, 1500);
            } catch (error) {
                console.error('生成报告失败:', error);
                alert('报告生成失败，请稍后重试');
            }
        }

        // 查看报告
        function viewReport(reportId) {
            try {
                // 模拟API调用获取报告详情
                setTimeout(() => {
                    // 这里应该从API获取报告详情，现在使用模拟数据
                    const report = {
                        id: reportId,
                        name: '2024年第一季度基础监测报告',
                        type: 'basicMonitoring',
                        generateTime: '2024-04-01',
                        author: '农场主A',
                        status: 'generated',
                        content: {
                            temperatureData: '15-25°C',
                            humidityData: '60-80%',
                            soilMoisture: '40-60%',
                            lightIntensity: '1000-5000 lux'
                        }
                    };

                    // 渲染报告内容
                    renderReportView(report);
                }, 1000);
            } catch (error) {
                console.error('查看报告失败:', error);
                alert('查看报告失败，请稍后重试');
            }
        }

        // 渲染报告查看内容
        function renderReportView(report) {
            try {
                let contentHTML = '';

                // 根据报告类型生成不同的内容
                switch (report.type) {
                    case 'basicMonitoring':
                        contentHTML = `
                            <div class="report-section">
                                <h5>基础监测数据</h5>
                                <div class="report-details">
                                    <p><strong>温度数据:</strong> ${report.content.temperatureData || '--'}</p>
                                    <p><strong>湿度数据:</strong> ${report.content.humidityData || '--'}</p>
                                    <p><strong>土壤湿度:</strong> ${report.content.soilMoisture || '--'}</p>
                                    <p><strong>光照强度:</strong> ${report.content.lightIntensity || '--'}</p>
                                </div>
                            </div>
                        `;
                        break;

                    case 'cropGrowth':
                        contentHTML = `
                            <div class="report-section">
                                <h5>作物生长分析</h5>
                                <div class="report-details">
                                    <p><strong>生长阶段:</strong> ${report.content.growthStage || '--'}</p>
                                    <p><strong>生长速率:</strong> ${report.content.growthRate || '--'}</p>
                                    <p><strong>产量预测:</strong> ${report.content.yieldPrediction || '--'}</p>
                                    <p><strong>病害风险:</strong> ${report.content.diseaseRisk || '--'}</p>
                                </div>
                            </div>
                        `;
                        break;

                    case 'resourceEfficiency':
                        contentHTML = `
                            <div class="report-section">
                                <h5>资源效率分析</h5>
                                <div class="report-details">
                                    <p><strong>水资源利用率:</strong> ${report.content.waterUsage || '--'}</p>
                                    <p><strong>肥料利用率:</strong> ${report.content.fertilizerUsage || '--'}</p>
                                    <p><strong>能源消耗:</strong> ${report.content.energyConsumption || '--'}</p>
                                    <p><strong>资源效率:</strong> ${report.content.resourceEfficiency || '--'}</p>
                                </div>
                            </div>
                        `;
                        break;

                    case 'environmentalImpact':
                        contentHTML = `
                            <div class="report-section">
                                <h5>环境影响评估</h5>
                                <div class="report-details">
                                    <p><strong>碳足迹:</strong> ${report.content.carbonFootprint || '--'}</p>
                                    <p><strong>水污染指数:</strong> ${report.content.waterPollution || '--'}</p>
                                    <p><strong>生物多样性:</strong> ${report.content.biodiversity || '--'}</p>
                                    <p><strong>可持续性评分:</strong> ${report.content.sustainabilityScore || '--'}</p>
                                </div>
                            </div>
                        `;
                        break;

                    case 'comprehensiveValue':
                        contentHTML = `
                            <div class="report-section">
                                <h5>综合价值评估</h5>
                                <div class="report-details">
                                    <p><strong>经济价值:</strong> ${report.content.economicValue || '--'}</p>
                                    <p><strong>社会价值:</strong> ${report.content.socialValue || '--'}</p>
                                    <p><strong>环境价值:</strong> ${report.content.environmentalValue || '--'}</p>
                                    <p><strong>综合评分:</strong> ${report.content.comprehensiveScore || '--'}</p>
                                </div>
                            </div>
                        `;
                        break;

                    case 'custom':
                        contentHTML = `
                            <div class="report-section">
                                <h5>自定义报告</h5>
                                <div class="report-details">
                                    <p><strong>报告名称:</strong> ${report.content.customReportName || '--'}</p>
                                    <p><strong>报告类型:</strong> ${report.content.customReportType || '--'}</p>
                                    <p><strong>报告内容:</strong></p>
                                    <div style="background-color: white; padding: 15px; border-radius: 4px; white-space: pre-wrap;">
                                        ${report.content.customReportContent || '无内容'}
                                    </div>
                                </div>
                            </div>
                        `;
                        break;

                    default:
                        contentHTML = `
                            <div class="report-section">
                                <h5>报告内容</h5>
                                <div class="report-details">
                                    <p>未知报告类型，无法显示详细内容</p>
                                </div>
                            </div>
                        `;
                }

                const viewContentHTML = `
                    <h3>${report.name}</h3>
                    <div class="report-meta">
                        <p><strong>报告类型:</strong> ${report.type}</p>
                        <p><strong>生成时间:</strong> ${report.generateTime}</p>
                        <p><strong>作者:</strong> ${report.author}</p>
                        <p><strong>状态:</strong> ${report.status}</p>
                    </div>
                    
                    <div class="report-content-area">
                        ${contentHTML}
                    </div>
                    
                    <div class="report-actions" style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-primary" onclick="exportReport(${report.id})">导出报告</button>
                        <button class="btn btn-success" onclick="shareReport(${report.id})">分享报告</button>
                        <button class="btn btn-secondary" onclick="editReport(${report.id})">编辑报告</button>
                    </div>
                `;

                document.getElementById('viewReportContent').innerHTML = viewContentHTML;
                openModal('viewReportModal');
            } catch (error) {
                console.error('渲染报告查看内容失败:', error);
                alert('渲染报告内容失败，请稍后重试');
            }
        }

        // 编辑报告
        function editReport(reportId) {
            try {
                // 模拟API调用获取报告详情
                setTimeout(() => {
                    // 这里应该从API获取报告详情，现在使用模拟数据
                    const report = {
                        id: reportId,
                        name: '2024年第一季度基础监测报告',
                        type: 'basicMonitoring',
                        generateTime: '2024-04-01',
                        author: '农场主A',
                        status: 'generated',
                        content: {
                            temperatureData: '15-25°C',
                            humidityData: '60-80%',
                            soilMoisture: '40-60%',
                            lightIntensity: '1000-5000 lux'
                        }
                    };

                    // 填充编辑表单
                    document.getElementById('reportTitle').value = report.name;
                    document.getElementById('reportType').value = report.type;
                    document.getElementById('reportAuthor').value = report.author;

                    // 根据报告类型填充内容
                    showReportContent(report.type);

                    switch (report.type) {
                        case 'basicMonitoring':
                            document.getElementById('temperatureData').value = report.content.temperatureData;
                            document.getElementById('humidityData').value = report.content.humidityData;
                            document.getElementById('soilMoisture').value = report.content.soilMoisture;
                            document.getElementById('lightIntensity').value = report.content.lightIntensity;
                            break;
                        // 其他报告类型的填充逻辑...
                    }

                    openModal('editReportModal');
                }, 1000);
            } catch (error) {
                console.error('编辑报告失败:', error);
                alert('编辑报告失败，请稍后重试');
            }
        }

        // 分享报告
        function shareReport(reportId) {
            try {
                // 模拟API调用获取报告共享信息
                setTimeout(() => {
                    // 这里应该从API获取报告共享信息，现在使用模拟数据
                    const shareInfo = {
                        users: ['user1', 'user2'],
                        permission: 'view'
                    };

                    // 渲染分享设置表单
                    const shareContentHTML = `
                        <h3>分享报告</h3>
                        <input type="hidden" id="shareReportId" value="${reportId}">
                        <div class="form-section">
                            <h3>共享设置</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="shareUsers">共享给</label>
                                    <select id="shareUsers" multiple>
                                        <option value="user1" selected>农场主B</option>
                                        <option value="user2" selected>技术人员</option>
                                        <option value="user3">管理员</option>
                                        <option value="group1">农场管理组</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="sharePermission">访问权限</label>
                                    <select id="sharePermission">
                                        <option value="view" ${shareInfo.permission === 'view' ? 'selected' : ''}>仅查看</option>
                                        <option value="edit" ${shareInfo.permission === 'edit' ? 'selected' : ''}>可编辑</option>
                                        <option value="export" ${shareInfo.permission === 'export' ? 'selected' : ''}>可导出</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <button class="btn btn-primary" onclick="saveShareSettings(${reportId})">保存设置</button>
                            <button class="btn btn-secondary" onclick="closeModal('shareReportModal')">取消</button>
                        </div>
                    `;

                    document.getElementById('shareReportContent').innerHTML = shareContentHTML;
                    openModal('shareReportModal');
                }, 1000);
            } catch (error) {
                console.error('获取共享信息失败:', error);
                alert('共享信息加载失败，请稍后重试');
            }
        }

        // 保存共享设置
        function saveShareSettings(reportId) {
            try {
                const shareUsers = Array.from(document.getElementById('shareUsers').selectedOptions).map(option => option.value);
                const sharePermission = document.getElementById('sharePermission').value;

                const shareData = {
                    users: shareUsers,
                    permission: sharePermission
                };

                // 模拟API调用，实际项目中替换为真实API
                setTimeout(() => {
                    alert('共享设置保存成功！');
                    closeModal('shareReportModal');
                }, 1000);
            } catch (error) {
                console.error('保存共享设置失败:', error);
                alert('共享设置保存失败，请稍后重试');
            }
        }

        // 导出报告
        function exportReport(reportId) {
            try {
                // 显示导出选项
                const exportOptions = `
                    <div class="export-options">
                        <h4>选择导出格式</h4>
                        <div style="display: flex; gap: 20px; margin: 20px 0;">
                            <div style="flex: 1;">
                                <input type="radio" id="exportPDF" name="exportFormat" value="pdf" checked>
                                <label for="exportPDF">PDF格式</label>
                            </div>
                            <div style="flex: 1;">
                                <input type="radio" id="exportExcel" name="exportFormat" value="xlsx">
                                <label for="exportExcel">Excel格式</label>
                            </div>
                            <div style="flex: 1;">
                                <input type="radio" id="exportWord" name="exportFormat" value="docx">
                                <label for="exportWord">Word格式</label>
                            </div>
                        </div>
                        
                        <div class="progress-container" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill">0%</div>
                            </div>
                            <p class="progress-text" style="text-align: center; margin-top: 10px;">准备下载...</p>
                        </div>
                        
                        <div style="text-align: right;">
                            <button class="btn btn-primary" onclick="downloadReport(${reportId})">立即导出</button>
                            <button class="btn btn-secondary" onclick="closeModal('exportReportModal')">取消</button>
                        </div>
                    </div>
                `;

                let exportModal = document.getElementById('exportReportModal');
                if (!exportModal) {
                    exportModal = document.createElement('div');
                    exportModal.id = 'exportReportModal';
                    exportModal.className = 'modal';
                    exportModal.innerHTML = `
                        <div class="modal-content">
                            <span class="close" onclick="closeModal('exportReportModal')">&times;</span>
                            <div id="exportReportContent">
                                ${exportOptions}
                            </div>
                        </div>
                    `;
                    document.body.appendChild(exportModal);
                } else {
                    document.getElementById('exportReportContent').innerHTML = exportOptions;
                }

                openModal('exportReportModal');
            } catch (error) {
                console.error('导出报告失败:', error);
                alert('导出报告失败，请稍后重试');
            }
        }

        // 下载报告
        function downloadReport(reportId) {
            try {
                // 获取选择的导出格式
                const selectedFormat = document.querySelector('input[name="exportFormat"]:checked').value;

                // 获取报告信息（用于生成文件名）
                const reportName = `报告_${reportId}`;
                const fileName = `${reportName}_${new Date().toISOString().slice(0, 10)}.${selectedFormat}`;

                // 显示下载进度
                const progressContainer = document.querySelector('.progress-container');
                const progressFill = document.querySelector('.progress-fill');
                const progressText = document.querySelector('.progress-text');

                if (progressContainer && progressFill && progressText) {
                    progressContainer.style.display = 'block';
                    progressFill.style.width = '0%';
                    progressFill.textContent = '0%';
                    progressText.textContent = '准备下载...';
                }

                // 构建下载URL
                const downloadUrl = `${API_BASE_URL}/reports/${reportId}/export?format=${selectedFormat}`;

                // 使用fetch API下载文件
                fetch(downloadUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        // 如果需要认证，请添加认证头
                        // 'Authorization': 'Bearer ' + token
                    }
                })// 检查响应是否成功
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        // 获取文件大小（如果响应头中有）
                        const contentLength = response.headers.get('Content-Length');
                        const total = contentLength ? parseInt(contentLength, 10) : 0;
                        let downloaded = 0;

                        // 创建一个ReadableStream来处理下载进度
                        const reader = response.body.getReader();
                        const chunks = [];

                        return new ReadableStream({
                            start(controller) {
                                function push() {
                                    reader.read().then(({ done, value }) => {
                                        if (done) {
                                            controller.close();
                                            return;
                                        }

                                        chunks.push(value);
                                        downloaded += value.length;

                                        // 更新进度条
                                        if (total > 0 && progressFill && progressText) {
                                            const progress = Math.round((downloaded / total) * 100);
                                            progressFill.style.width = `${progress}%`;
                                            progressFill.textContent = `${progress}%`;
                                            progressText.textContent = `正在下载... ${formatBytes(downloaded)} / ${formatBytes(total)}`;
                                        }

                                        controller.enqueue(value);
                                        push();
                                    }).catch(error => {
                                        console.error('读取响应失败:', error);
                                        controller.error(error);
                                    });
                                }
                                push();
                            }
                        });
                    })// 将ReadableStream转换为Blob
                    .then(stream => {
                        return new Response(stream).blob();
                    })// 创建下载链接并触发下载
                    .then(blob => {
                        // 创建下载链接
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;

                        // 触发下载
                        document.body.appendChild(a);
                        a.click();

                        // 清理
                        setTimeout(() => {
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(url);
                        }, 100);

                        // 更新进度条
                        if (progressFill && progressText) {
                            progressFill.style.width = '100%';
                            progressFill.textContent = '100%';
                            progressText.textContent = '下载完成！';
                        }

                        // 延迟关闭模态框
                        setTimeout(() => {
                            closeModal('exportReportModal');
                            if (document.getElementById('viewReportModal').style.display === 'block') {
                                closeModal('viewReportModal');
                            }
                        }, 500);
                    })
                    .catch(error => {
                        console.error('下载报告失败:', error);
                        alert(`下载报告失败: ${error.message}`);

                        // 隐藏进度条
                        if (progressContainer) {
                            progressContainer.style.display = 'none';
                        }
                    });
            } catch (error) {
                console.error('下载报告失败:', error);
                alert('下载报告失败，请稍后重试');
            }
        }

        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
        }
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // 格式化字节数
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
    </script>
</body>

</html>